INPUT = """                                                                                                                                                                   |                                     
                       +---------------------------------------------------------------------------+             +---------------------+             +---+       +-------------------------------------+ 
                       |                                                                           |             |                     |             |   |       | |                                   | 
                     +---------------+                     +---------------+               +-------|-------------------------------------+           |   |       | |         +-----------+       +-----+ 
                     | |             |                     |               |               |       |             |                     | |           |   |       | |         |           |       |       
         +---+       | | +-------+   |                     | +-----------------------------|-------------------------------------------|-----------+ |   |       | |         |           | +-----------+ 
         |   |       | | |       |   |                     | |             |               |       |             |                     | |         | |   |       | |         |           | |     |     | 
 +-----------+       | +-|-----------|-----------+         | +---+         |               |       |           +-----------------------|-|---------------|-------|-----------|-----------------------+ | 
 |       |           |   |       |   |           |         |     |         |               |       |           | |                     | |         | M   |       | |         |           | |     |   | | 
 |       |           | +-|-----------|---------------------|-----+         |               |       |           | |           +---------+ +-+     +---------------|-----------|---------------+   | +-+ | 
 |       |           | | |       |   |           |         |               |               |       |           | |           |             |     | | |   |       | |         |           | | |   | |   | 
 |       |           | | |       +-------------------------|---------------|---------------|-------|-------+   | |     +-----+         +-----+   | | |   |       | |         | +---+ +-+ | | |   | |   | 
 |       |           | | |           |           |         |               |               |       |       |   | |     |               |   | |   | | |   |       | |         | |   | | | | | |   | |   | 
 |       |           +---|-+         |   +---+   |         +---------------------------------------|-------------|---------------------------|-----|-|---|-------|---------------------|-|-|---------+ | 
 |       |             | | |         |   |   |   |                         |               |       |       |   | |     |               |   | |   | | |   |       | |         | |   | | | | | |   | | | | 
 |       |   +---+     | | |         |   |   |   |                         |       +-------|-------|-------|---|-|-----|---------------|-----------|-------------|-|-----------|---|-|-|-|---+   | | | | 
 |       |   |   |     | | |         |   |   |   |                         |       |       |       |       |   | |     |               |   | |   | | |   |       | |         | |   | | | | |     | | | | 
 |       |   |   |     | | |         |   |   |   |                         |       +-----------------------------|---------------------|---|-|-------------------|-|-----------|---|-|-|-|-------|-|---+ 
 |       |   |   |     C | |         |   |   |   |                         |               |       |       |   | |     |               |   | |   | | |   |       | |         | |   | | | | |     | | |   
 |       | +-|---|-----|-|-----------|-------|-----------------------------|-------------+ |       |       |   | |     |     +-------------|-|---|-|-|---|---+   | |         | |   | | | | |     | | |   
 |       | | |   |     | | |         |   |   |   |                         |             | |       |       |   | |     |     |         |   | |   | | |   |   |   | |         | |   | | | | |     | | |   
 |       | +-|---|-----|-------------|-------|-----------------------------|---------------|-------------------|-------|-----|---------|---|-+   | | |   |   |   | |         | | +-|---|---|-----|-+ |   
 |       |   |   |     | | |         |   |   |   |                         |             | |       |       |   | |     |     |         |   |     | | |   |   |   | |         | | | | | | | |     |   |   
 | +---+ |   |   |     | | |         |   | +-+   |                   +---------------------|---+   |       |   | |     |     |         | +-|-----|-|-------------|-----------+ | | | | | | |     | +---+ 
 | |   | |   |   |     | | |         |   | |     |                   |     |             | |   |   |       |   | |     |     |         | | |     | | |   |   |   | |           | | | | | | |     | | P | 
 | |   | |   |   |     | | |         |   | |     |           +-+     |     |             | |   |   |       |   | |     |     |         | | |     | | |   |   |   | |           | | | | | | |     | | | | 
 | |   | |   |   |     | | |         |   | |     |           | |     |     |             | |   |   |       |   | |     |     |         | | |     | | |   |   |   | |           | | | | | | |     | | | | 
 | |   | |   |   | +---|-+ |         +---|-|-----|-----------|-+     |     |             | |   |   |       |   | |     |     |         | | |     | | |   |   |   | |           | | | | | | |     | | | | 
 | |   | |   |   | |   |   |             | |     |           |       |     |             | |   |   |       |   | |     |     |         | | |     | | |   |   |   | |           | | | | | | |     | | | | 
 | |   | |   |   | |   |   |             | |     |           |       |     |             | |   |   |       |   | |     | +---|---------+ | | +---|-|-|---|---------|-----------|-+ +-+ | | |     | | | | 
 | |   | |   |   | |   |   |             | |     |           |       |     |             | |   |   |       |   | |     | |   |           | | |   | | |   |   |   | |           |       | | |     | | | | 
 | |   | |   |   | |   |   |             | |     |           |       |     |             | |   |   |       |   | |     | |   +-------+   | | |   | | |   |   |   | |         +-------+ | | |     | | | | 
 | |   | |   |   | |   |   |             | |     |           |       |     |             | |   |   |       |   | |     | |           |   | | |   | | |   |   |   | |         | |     | | | |     | | | | 
 | | +---|---|---|---------|-----+ +-----|-|-----|-------------------|-----|-------------|-|-------|-----------|-|-----|-------------------|-------|---------|---|-----------|-----------+ |     | | | | 
 | | | | |   |   | |   |   |     | |     | |     |           |       |     |             | |   |   |       |   | |     | |           |   | | |   | | |   |   |   | |         | |     | |   |     | | | | 
 | | | | |   |   | |   |   |     | |     | |     |           |       |     |             | |   |   |       |   | |     | |           |   | | |   | | |   |   |   | |         | |     | | +-------+ | | | 
 | | | | |   |   | |   |   |     | |     | |     |           |       |     |             | |   |   |       |   | |     | |           |   | | |   | | |   |   |   | |         | |     | | | |       | | | 
 | | | | |   |   | |   |   |     | |     | | +---+           |       |     |             | |   |   |       |   | |     | |           |   | | |   | | |   |   |   | |       +-|-+ Y +-|-|-----+     | | | 
 | | | | |   |   | |   |   |     | |     | | |               |       |     |             | |   |   |       |   | |     | |           |   | | |   | | |   |   |   | |       | |   | | | | | | |     | | | 
 | | | | |   |   | |   |   |     | |     | | |               |       |     |             | |   |   |       |   | |     | |       +-+ |   | | |   | | |   |   |   | |       | |   | | | | | | |     | | | 
 | | | | |   |   | |   |   |     | |     | | |               |       |     |             | |   |   |       |   | |     | |       | | |   | | |   | | |   |   |   | |       | |   | | | | | | |     | | | 
 | | | | |   |   +-|-------|-----|-|-----|-------------------|-------------|---------------|---------------------|-----|-|---------|-|---|-|-|-------|---|-------+ |       | |   | | | | | | |     | | | 
 | | | | |   |     |   |   |     | |     | | |               |       |     |             | |   |   |       |   | |     | |       | | |   | | |   | | |   |   |     |       | |   | | | | | | |     | | | 
 | | | | |   |     |   |   |     | |     | | |               |       |     |       +-----|---------|-------------|---------------|---|---|-|-|-----|-+   |   |     +-------|-+   +---|---|-------+ | | | 
 | | | | |   |     |   |   |     | |     | | |               |       |     |       |     | |   |   |       |   | |     | |       | | |   | | |   | |     |   |             |       | | | | | |   | | | | 
 | | | | |   |     |   |   |     | |     | | |               |       |     |       |     | +-------------------|-------|-------------|---+ | |   | |     |   |             |       | | | | | |   | | | | 
 | | | | |   |     |   |   |     | |     | | |               |       |     |       |     |     |   |       |   | |     | |       | | |     | |   | |     |   |             |       | | | | | |   | | | | 
 | | | | |   |     |   |   |     | |     | | |               |       |   +-|-------------------|---|-----+ |   | |     | |       | | |     | |   | |     |   |             |       | | | | | |   | | | | 
 | | | | |   |     |   |   |     | |     | | |               |       |   | |       |     |     |   |     | |   | |     | |       | | |     | |   | |     |   |             |       | | | | | |   | | | | 
 | | | | |   |     |   |   |     | |     | | |               |       |   | |       |     |     |   |     | |   | |     | |       | | |     | |   | |     |   |             |       | | | | | |   | | | | 
 | | | | |   |     |   |   |     | |     | | |               |       |   | |       |     |     |   |     | |   | |     | |       | | |     | |   | |     |   |             |       | | | | | |   | | | | 
 | | | | |   |     |   |   |     | |     | | |               |       |   | | +-----|-----|---------|-------|---|-|-------------------|---------------------------------------------|-|-----|---+ | | | | 
 | | | | |   |     |   |   |     | |     | | |               |       |   | | |     |     |     |   |     | |   | |     | |       | | |     | |   | |     |   |             |       | | | | | | | | | | | 
 | | | | |   |     |   |   |     | |     | | |               |       |   | | |     |     |     |   |     | |   | |     | |       | | |     | |   | |   +-|-+ |             |       | | | | | | | | | | | 
 | | | | |   |     |   |   |     | |     | | |               |       |   | | |     |     |     |   |     | |   | |     | |       | | |     | |   | |   | | | |             |       | | | | | | | | | | | 
 | | | | |   |     |   |   |     | |     | | |               |       |   | | |     |     |     |   |     | |   | |     | |       | | |     | |   | |   | | | |             |       | | | | | | | | | | | 
 | | | | |   |     |   |   |     | |     | | |               |       |   | | |     |     |     |   |     | |   | |     | |       | | |     | |   | |   | | | |             |       | | | | | | | | | | | 
 | | | | |   |     |   |   |     | |     | | |               | +-----|---|-|-|-----|-----|-+   |   |     | |   | |     | |       | | |     | |   | |   | | | |             |       | | | | | | | | | | | 
 | | | | |   |     |   |   |     | |     | | |               | |     |   | | |     |     | |   |   |     | |   | |     | |       | | |     | |   | |   | | | |             |       | | | | | | | | | | | 
 | | | | |   |     |   |   |     | |     | | |               | |   +-------|-|-----|-----|-+   |   | +---+ |   +---------|-------|---------|-|---|-----|-|-|-+             |       | | | | | | | | | | | 
 | | | | |   |     |   |   |     | |     | | |               | |   | |   | | |     |     |     |   | |     |     |     | |       | | |     | |   | |   | | |               |       | | | | | | | | | | | 
 | | | | |   |     |   |   |     | |   +---|-|---------------|-|---|-|-----|-------------|-+   |   | |     +-----------|-------------|---------+ | |   | | |       +-----+ |       | | | | | | | | | | | 
 | | | | |   |     |   |   |     | |   | | | |               | |   | |   | | |     |     | |   |   | |           |     | |       | | |     | | | | |   | | |       |     | |       | | | | | | | | | | | 
 | | | | |   |     |   |   |     | |   | | | |               | |   | |   | | |     |     | |   |   | |   +-------|---------------------------|---|-------|---+     +-------|---+   | | | | | | | | | | | 
 | | | | |   |     |   |   |     | |   | | | |               | |   | |   | | |     |     | |   |   | |   |       |     | |       | | |     | | | | |   | | | |           | |   |   | | | | | | | | | | | 
 | | | | |   |     |   |   |     | |   +-+ | |               | |   | |   | | |     |     | |   |   | |   |       |     | |       | | |     | | | | |   | | | |           | |   |   | | | | | | | | | | | 
 | | | | |   |     |   |   |     | |       | |               | |   | |   | | |     |     | |   |   | |   |       |     | |       | | |     | | | | |   | | | |           | |   |   | | | | | | | | | | | 
 | | | | |   |     |   |   |     | |   +-----|---------------|-|-----------|-|-----|-----|-|---|---|-----------------+ | |       | | |     | | | | |   | | | |           | |   |   | | | | | | | | | | | 
 | | | | |   |     |   |   |     | |   |   | |               | |   | |   | | |     |     | Q   |   | |   |       |   | | |       | | |     | | | | |   | | | |           | |   |   | | | | | | | | | | | 
 | | | | |   |     |   |   |     | |   |   | |               | |   | |   | | |     |     | |   |   | |   |       |   | +-----+   | | |     | | | | |   | +-+ |           | |   |   | | | | | | | | | | | 
 | | | | |   |     |   |   |     | |   |   | |               | |   | |   | | |     |     | |   |   | |   |       |   |   |   |   | | |     | | | | |   |     |           | |   |   | | | | | | | | | | | 
 | | | +-----------|---|---------|-|-----------------------+ | |   | |   | | |     |     | |   |   | |   |       |   | +---------------------|-|-|-----------|----------E------+   | | | | | | | | | | | 
 | | |   |   |     |   |   |     | |   |   | |             | | |   | |   | | |     |     | |   |   | |   |       |   | | |   |   | | |     | | | | |   |     |           | |       | | | | | | | | | | | 
 | | |   |   |     |   |   |     | |   |   | |             | | |   | |   | | |     |     +---------|-|---|-----------|-|-|---+   | | |     | | | | |   |     |           | |       | | | | | | | | | | | 
 | | |   |   |     |   |   |     | |   |   | |             | | |   | |   | | |     |       |   |   | |   |       |   | | |       | | |     | | | | |   |     |           | |       | | | | | | | | | | | 
 | | |   |   |     |   |   |     | |   |   | |             | | |   | |   | | | +---|-------|---|-+ | | +-|-------------|-|-----------|-----|---|-----+ |     |           +-+       | | | | | | | | | | | 
 | | |   |   |     |   |   |     | |   |   | |             | | |   | |   | | | |   |       |   | | | | | |       |   | | |       | | |     | | | | | | |     |                     | | | | | | | | | | | 
 | | |   |   |     |   |   |     | |   |   | |   +-----------------|-|---|-----|-----------|---|-|---------------|-----|-------------------|-|-|-----|---------------+             | | | | | | | | | | | 
 | | |   |   |     |   |   |     | |   |   | |   |         | | |   | |   | | | |   |       |   | | | | | |       |   | | |       | | |     | | | | | | |     |       |             | | | | | | | | | | | 
 | | |   |   |     |   |   |     | |   |   | |   |         | | |   | |   +---|-|---|-------|---|-----|---|-----------|---------------|-----|-------|---|-----|-----------------+   | | | | | | | | | | | 
 | | |   |   |     |   |   |     | |   |   | |   |         | | |   | |     | | |   |       |   | | | | | |       |   | | |       | | |     | | | | | | |     |       |         |   | | | | | | | | | | | 
 | | |   |   |     |   |   |     | |   |   | |   +-------+ | | |   | |     | | |   |       |   | | | | | |       |   | | |       | | |     | | | | | | |     |       |         |   | | | | | | | | | | | 
 | | |   |   |     |   |   |     | |   |   | |           | | | |   | |     | | |   |       |   | | | | | |       |   | | |       | | |     | | | | | | |     |       |         |   | | | | | | | | | | | 
 | | |   |   |     |   +---------------|-+ | |         +-|-|-------------------|-----------|-----|-|-|-|---------------|-|-----------|-----|-|-|---------------------|-------------|-|-|-|-----|-|-+ | | 
 | | |   |   |     |       |     | |   | | | |         | | | | |   | |     | | |   |       |   | | | | | |       |   | | |       | | |     | | | | | | |     |       |         |   | | | | | | | |   | | 
 | | |   |   |   +-|---+   |     | |   | | | |         | | | | |   | |     | +-|---|-----+ |   +---|---|-|---+   |   | | +-------|-|-------|---|-|---|-------|-----+ |       +-------|-----+ | | |   | | 
 | | |   |   |   | |   |   |     | |   | | | |         | | | | |   | |     |   |   |     | |     | | | | |   |   |   | |         | | |     | | | | | | |     |     | |       | |   | | | |   | | |   | | 
 | | +-+ |   |   | |   |   |     | |   | | +-----------|-|-|---|---|-------|---|---|---------------|-|-|---------+   | |       +-|---|---------|-|-----------|-------|-------|-----|-----|-----|---+ | | 
 | |   | |   |   | |   |   |     | |   | |   |         | | | | |   | |     |   |   |     | |     | | | | |   |       | |       | | | |     | | | | | | |     |     | |       | |   | | | |   | | | | | | 
 | |   | |   |   | |   |   |     | |   | |   |         | | | | |   | |     |   |   |     | |     | | | | |   |       | |       | | | |     | | | | | | |     |     | |       | |   | | +-------|-|-+ | | 
 | |   | |   |   | |   |   |     | |   | |   |         | | | | |   | |     |   H   |     | |     | | | | |   |       | |       | | | |     | | | | | | |     |     | |       | |   | |   |   | | |   | | 
 | |   | | +-|---|-----+   |     | |   | |   |         | | | | |   | |     |   |   |     +-|-------|---|-|-----------|-----------|-|---+   | | | | | | |     |     | |       | |   | |   |   | | |   | | 
 | |   | | | |   | |       |     | |   | |   |         | | | | |   | |     |   |   |       |     | | | | |   |       | |       | | | | |   | | | | | | |     |     | |       | |   | |   |   | | |   | | 
 | |   | | | |   | |       |     | |   | |   |         | | | | |   | |     |   |   |       |     | | | | |   | +-----|-|-------|-|-----|---|-----|-------------------|-------|-+   | |   |   | | |   | | 
 | |   | | | |   | |       |     | |   | |   |         | | | | |   | |     |   |   |       |     | | | | |   | |     | |       | | | | |   | | | | | | |     |     | |       |     | |   |   | | |   | | 
 | |   | | | |   | |       |     | |   | |   |         | | | | |   | |     |   |   |       |     | | | | |   | |     | |       | | | | |   | | | | | | |     |     +-|-----+ |     | |   |   | | |   | | 
 | |   | | | |   | |       |     | |   | |   |         | | | | |   | |     |   |   |       |     | | | | |   | |     | |       | | | | |   | | | | | | |     |       |     | |     | |   |   | | |   | | 
 | |   | | | |   | |       | +---|-|---|-|---|-----------|---|-----|-|---------|---|-------------|-|-----|-----|-------|-------|-------|---|---|-|-|-|-----------------------------------|-------------+ 
 | |   | | | |   | |       | |   | |   | |   |         | | | | |   | |     |   |   |       |     | | | | |   | |     | |       | | | | |   | | | | | | |     |       |     | |     | |   |   | | |   |   
 | |   | | | |   | |       | |   | |   | |   |         | | | | |   | |     |   | +-|-------|---+ | | | | |   | |     | |       | | | | |   | | | | | | |     |       |     | | +-----|-+ |   | | |   |   
 | |   | | | |   | |       | |   | |   | |   |         | | | | |   | |     |   | | |       |   | | | | | |   | |     | |       | | | | |   | | | | | | |     |       |     | | |   | | | |   | | |   |   
 | |   | | | |   | | +-------|---|-------|---------------|-|---------|-----|---|-----------|---|-|-|-|-----------------------------|-------|-|---------+     |       |     | | |   | | | |   | | |   |   
 | |   | | | |   | | |     | |   | |   | |   |         | | | | |   | |     |   | | |       |   | | | | | |   | |     | |       | | | | |   | | | | | |       |       |     | | |   | | | |   | | |   |   
 | |   | | | |   | | |     | +-+ | |   | |   |     +---|-----|-----------------|-|-------+ |   | | | | | | +-|-------+ |       | | | | |   | | | | | |       |       |     | | |   | | | |   | | |   |   
 | |   | | | |   | | |     |   | | |   | |   |     |   | | | | |   | |     |   | | |     | |   | | | | | | | | |       |       | | | | |   | | | | | |       |       |     | | |   | | | |   | | |   |   
 | |   | | | |   | | |     |   | | |   | |   |     |   | | | | |   | |     |   | | |     | |   | | | | | | | | |       |       +---|---|-------|-|---|-----------------+   | | |   | +---+   | | |   |   
 | |   | | | |   | | |     |   | | |   | |   |     |   | | | | |   | |     |   | | |     | |   | | | | | | | | |       |         | | | |   | | | | | |       |       | |   | | |   |   |     | | |   |   
 | |   | | | |   | | |     |   | | |   | |   | +-------|-|-|-|-------|---------|-|-------------|-|---|-|-----|-|-------------------|-------|-|-------|-------------+ | |   | | |   |   |     | | |   |   
 | |   | | | |   | | |     |   | | |   | |   | |   |   | | | | |   | |     |   | | |     | |   | | | | | | | | |       |         | | | |   | | | | | |       |     | | |   | | |   |   |     | | |   |   
 | |   | | | |   | | |     |   | | +-----+   | |   |   | | | | |   | |     |   | +---------|-----+ | +-+ | | | |       |         | | | |   | | | | | |       |     | | |   | | |   |   |     | | |   |   
 | |   | | | |   | | |     |   | |     |     | |   |   | | | | |   | |     |   |   |     | |   |   |     | | | |       |         | | | |   | | | | | |       |     | | |   | | |   |   |     | | |   |   
 | |   | | | |   | | |     |   | |   +-|-----------|---|-|---|-------+ +-------|-----------+   |   |     | | | |       |         | | | |   | | | | | |       |     | | |   | | |   |   |     | | |   |   
 | |   | | | |   | | |     |   | |   | |     | |   |   | | | | |   |   |   |   |   |     |     |   |     | | | |       |         | | | |   | | | | | |       |     | | |   | | |   |   |     | | |   |   
 | |   | | | |   | | |     |   | |   | |     | |   |   | | | | |   |   |   |   |   |     |     | +-|-----+ | | |       |         | | | |   | | | | | |       |     | | |   | | |   |   |     | | |   |   
 | |   | | | |   | | |     |   | |   | |     | |   |   | | | | |   |   |   |   |   |     |     | | |       | | |       |         | | | |   | | | | | |       |     | | |   | | |   |   |     | | |   |   
 | |   | | | |   | | |     |   | |   | |     | |   |   | | | | |   |   |   |   |   |     |   +---|-|---------|-|---------------+ | | | |   | | | | | |       |     | | |   | | |   |   |     | | |   |   
 | |   | | | |   | | |     |   | |   | |     | |   |   | | | | |   |   |   |   |   |     |   | | | |       | | |       |       | | | | |   | | | | | |       |     | | |   | | |   |   |     | | |   |   
 | |   | | | |   | | |     |   | |   | | +---|---------|---|---------------|---|---|-----|---------|-------|---------------------|---|-------|-|-|-----+     |     | | |   | | |   |   |     | | |   |   
 | |   | | | |   | | |     |   | |   | | |   | |   |   | | | | |   |   |   |   |   |     |   | | | |       | | |       |       | | | | |   | | | | | | |     |     | | |   | | |   |   |     | | |   |   
 | |   | | +-|-+ | | |     |   | |   | | |   | |   |   | | | | |   |   |   |   |   |     |   | +-|---------|-------------------|-----------|---|-----|-------|-----|---------|-+   |   |     | | |   |   
 | |   | |   | | | | |     |   | |   | | |   | |   |   | | | | |   |   |   |   |   |     |   |   | |       | | |       |       | | | | |   | | | | | | |     |     | | |   | |     |   |     | | |   |   
 | |   | |   | | | | |     |   | |   | | |   | |   |   | | | | |   |   |   |   |   |     |   |   | |       | | |       |       | | | | |   | | | | | | |     |   +-----|-----+     |   |     | | |   |   
 | |   | |   | | | | |     |   | |   | | |   | |   |   | | | | |   |   |   |   |   |     |   |   | |       | | |       |       | | | | |   | | | | | | |     |   | | | |   |       |   |     | | |   |   
 | |   +-|---|-|---|-|-----|---|-|---|-|-+ +---|-+ |   | | | | |   |   +-------|-----+   |   |   | |       | | |       |       | | | | |   | | | | | | |     |   | | | |   |       |   |     | | |   |   
 | |     |   | | | | |     |   | |   | |   | | | | |   | | | | |   |       |   |   | |   |   |   | |       | | |       |       | | | | |   | | | | | | |     |   | | | |   |       |   |     | | |   |   
 | | +---+   | | | | |     |   | |   | |   | | | | |   | | | | |   |       |   |   | |   +---|-----|-------|-|-----------------|-|-|-|-|---|-|---|-|-|-|-------------------|-------|---|-----+ | |   |   
 | | |       | | | | |     |   | |   | |   | | | | |   | | | | |   |       |   |   | |       |   | |       | | |       |       | | | | |   | | | | | | |     |   | | | |   |       |   |       | |   |   
 | | | +-----|---+ | |     |   | |   | |   | | | | |   | | | | |   |       |   |   | |       |   | |       | | |       |       | | | | |   | | | | | | |     |   | | | |   |       |   |       | |   |   
 | | | |     | |   | |     |   | |   | |   | | | | |   | | | | |   |       |   |   | |       |   | |       | | |       |       | | | | |   | | | | | | |     |   | | | |   |       |   |       | |   |   
 | | | |     | |   | |     |   | |   | |   | | | | |   | | | | |   |       |   |   | |       |   | | +-------|---------|-------|-|-|-------|-----|-|-|-|---------|-----|-----+     |   |       | |   |   
 | | | |     | |   | |     |   | |   | |   | | | | |   | | | | |   |       |   |   | |       |   | | |     | | |       |       | | | | |   | | | | | | |     |   | | | |   | |     |   |       | |   |   
 | | | |     | |   | |     |   | |   | |   | | | | | +-|-+ | +-------------|---|---|---------|-------------|-|---------|-------|---|-|-|-------|-|-|---------|-------|-|---|-----------|-----+ | |   |   
 | | | |     | |   | |     |   | |   | |   | | | | | | |   |   |   |       |   |   | |       |   | | |     | | |       |       | | | | |   | | | | | | |     |   | | | |   | |     |   |     | | |   |   
 | | | | +-----|-----|---------|-+   | |   | | | | | | |   |   |   |       |   |   | |       |   | | |     | | |       |       | | | | |   | | | | | | |     |   | | | |   | |     |   | +-----+ |   |   
 | | | | |   | |   | |     |   |     | |   | | | | | | |   |   |   |       |   |   | |       |   | | |     | | |       |       | | | | |   | | | | | | |     |   | | | |   | |     |   | |   |   |   |   
 | | | | |   | |   | |     |   |     | |   | | | | | | |   |   |   |       |   |   | |       |   | | |     | | |       |       | | | | |   | | | | | | |     |   | | | |   | |     |   | |   |   |   |   
 | | | | |   | |   | |     |   |     | |   | | | | | | |   |   |   |       |   |   | |       |   | | |     | | |       |       | | | | |   | | | | | | |     |   | | | |   | |     |   | |   |   |   |   
 | | | | |   | |   | |     |   |     | |   | | | | | | +-------|-----------|-------|-|-------|-----+ |     | | |       |       +---|-|-|---|-|-|-+ | | |     |   | | | |   | |     |   | |   |   |   |   
 | | | | |   | |   | |     |   |     S |   | | | | | |     |   |   |       |   |   | |       |   |   |     | | |       |         | | | |   | | |   | | |     |   | | | |   | |     |   | |   |   |   |   
 | | | | |   | |   | |     |   |     | |   | | | | | | +---|-------|---------------------------------|---------|-----------------|---|-|---|-|---+ | | |   +---------|-----|---------+ | |   |   | +-|-+ 
 | | | | |   | |   | |     |   |     | |   | | | | | | |   |   |   |       |   |   | |       |   |   |     | | |       |         | | | |   | | | | | | |   | |   | | | |   | |     | | | |   |   | | | | 
 +-----|-|---|-|---|-----------|-----|-|---|-----|---------|---+   |       |   |   | |   +-------|-+ |     | | |       |         | | | |   | | | | | | |   | |   | | | |   | |     | | | |   |   | | | | 
   | | | |   | |   | |     |   |     | |   | | | | | | |   |       |       |   |   | |   |   |   | | |     | | |       |         | | | |   | | | | | | |   | |   | | | |   | |     | | | |   |   | | | | 
   | | | |   | | +---|-----|---------|-----|---|-|-|-|-----|-------|-------|---|-----|-------+ +-|-|-------|-|---------------------|-|-|-------------------|-|-+ | | +-|---+ |     | | | |   |   | | | | 
   | | | |   | | | | |     |   |     | |   | | | | | | |   |       |       |   |   | |   |     | | | |     | | |       |         | | | |   | | | | | | |   | | | | |   |     |     | | | |   |   | | | | 
 +-------------|-|-|-|-----|---------|-----|-|-----|-|---------------------|---|-----|---------|-|-|-|-------|---------+         | | | |   | | | | | | |   | | | | |   |     |     | | | |   |   | | | | 
 | | | | |   | | | | |     |   |     | |   | | | | | | |   |       |       |   |   | |   |     | | | |     | | |                 | | | |   | | | | | | |   | | | | |   |     |     | | | |   |   | | | | 
 | | +-|-----|-|---|-|-----|---------------|---|---|---|---|-------|-------|-------|-----+     | | | |     | | |                 | | | |   | | +---|-+ |   | | | | |   |     |     | | | |   | +-+ | | | 
 | |   | |   | | | | |     |   |     | |   | | | | | | |   |       |       |   |   | |         | | | |     | | |                 | | | |   | |   | |   |   | | | | |   |     |     | | | |   | |   | | | 
 | | +---|---|-|-----------|---|-------|-------|---+ | |   |       |   +-----------------------|---|-------|---+ +---------------|-----+   | |   | |   |   | | | | |   |     |     | | | |   | |   | | | 
 | | | | |   | | | | |     |   |     | |   | | | |   | |   |       |   |   |   |   | |         | | | |     | |   |               | | |     | |   | |   |   | | | | |   |     |     | | | |   | |   | | | 
 | | | +---+ | +-|---|-+ +-----|-----|-+ +-+ | | |   | |   |       |   |   |   |   | |         | | | |     | |   |               | | |     | |   | |   |   | | | | |   |     |     | | | |   | |   | | | 
 | | |   | | |   | | | | | |   |     |   |   | | |   | |   |       |   |   |   |   | |         | | | |     | |   |               | | |     | |   | |   |   | | | | |   |     |     | | | |   | |   | | | 
 | | | +-|-----------|-|---|---+     | +-------|-+   | |   |       |   |   |   |   | |         +---|-+     | |   |               | | |   +-|-|-----|-----+ | | | | +---+     | +-+ | +-+ |   | |   | | | 
 | | | | | | |   | | | | | |         | | |   | |     | |   |       |   |   |   |   | |           | |       | |   |               | | |   | | |   | |   | | | | | |           | | | |     |   | |   | | | 
 | +-----|-|V------|-|---|-|---------|-|-------|-----|-----------------|-------------------------|---------|-----|---------------------------+   | |   | | +-|-+ |           | | | |     |   | |   | | | 
 |   | | | | |   | | | | | |         | | |   | |     | |   |       |   |   |   |   | |           | |       | |   |               | | |   | |     | |   | |   |   |           | | | |     |   | |   | | | 
 |   | +-|-|-----|-|-|-|---------------------|-|-------|---------------|---|-------|-------------|---------|-|-----------+       | | |   | |     | |   | |   |   |           | | | |     |   | |   | | | 
 |   |   | | |   | | | | | |         | | |   | |     | |   |       |   |   |   |   | |           | |       | |   |       |       | | |   | |     | |   | |   |   |           | | | |     |   | |   | | | 
 |   | +-----+   | | | | | |         +---|-----------|-|---------------|-------|---|-|-----------------------|---|-----------------|-----|-------|-|---|-|---|---+           | | | |     |   | |   | | | 
 |   | | | |     | | | | | |           | |   | |     | |   |       |   |   |   |   | |           | |       | |   |       |       | | |   | |     | |   | |   |               | | | |     |   | |   | | | 
 |   | +---------|-|---|-|-|-----------------|-|-------------------|-------|---|-------------------|---------|---------------------|-|-----|-------|---|-|---|-------------------|-|-----|---|-|-----+ | 
 |   |   | |     | | | | | |           | |   | |     | |   |       |   |   |   |   | |           | |       | |   |       |       | | |   | |     | |   | |   |               | | | |     |   | |   |   | 
 | +-|-----|-----+ +---|---|-----------------|---+   | |   |       |   |   |   |   | |           | |       | |   +-----------+   | | |   | |     | |   | |   |               +-|---|-----|-----+   |   | 
 | | |   | |         | | | |           | |   | | |   | |   |       |   |   |   |   | |           | |       | |           |   |   | | |   | |     | |   | |   |                 | | |     |   |     |   | 
 +-|-|-----|---------|-|-+ |           +-----|-|-+   | |   |       |   |   |   |   | |           | |       | |   +-----------|---+ | |   | |     | |   | |   |                 | | |     |   |     |   | 
   | |   | |         | |   |             |   | |     | |   |       |   |   |   |   | |           | |       | |   |       |   |     | |   | |     | |   | |   |                 | | |     |   |     |   | 
 +---------|---------|-|-----------------|-+ | |     | +---|-------|---|---|---|---------------+ | |       | |   |     +-|-------+ | |   | |     | |   | |   +---------------------|-+   |   +-----+   | 
 | | |   | |         | |   |             | | | |     |     |       |   |   |   |   | |         | | |       | |   |     | |   |   | | |   | |     | |   | |                     | | | |   |             | 
 | | | +---|---------+ +-+ |             | | | | +---------|---------------+   | +-|---------------|-------|-----|---------------|-|-----|-------|-------|---------------------|-|---+   |             | 
 | | | | | |             | |             | | | | |   |     |       |   |       | | | |         | | |       | |   |     | |   |   | | |   | |     | |   | |                     | | |     |             | 
 | | | | | |             | |             | | +---+   |     |   +---|-----------|---|-----------|-----------|-|---------|-|-----------|-----------|-|---|-|-------------------------|-----|-------------+ 
 | | | | | |             | |             | |   |     |     |   |   |   |       | | | |         | | |       | |   |     | |   |   | | |   | |     | |   | |                     | | |     |               
 | | | | | |             | |     +-------|-|-+ |     |     |   |   |   |       | | | |         | | | +-----------|-----+ |   +---+ | |   | |     | |   | +---------------------+ +-------|-------+       
 | | | | | |             | |     |       | | | |     |     |   |   |   |       | | | |         | | | |     | |   |       |         | |   | |     | |   |                           |     |       |       
 | | | | | |         +-----|-----|-+     | | +-|-----------|---|-----------------|---+         | | | +-----+ |   +-------|-----------+   | |     | |   |             +-------------|-------------+       
 | | | | | |         |   | |     | |     | |   |     |     |   |   |   |       | | |           | | |         |           |         |     | |     | |   |             |             |     |               
 | | | | | |         |   | |     | |     | |   | +---------|---|---|---|-------|-|-|-----------|-|-|---------|-------------------+ | +---|-------------+             +-------------|-----+               
 | | | | | |         |   | |     | |     | |   | |   |     |   |   |   |       | | |           | | |         |           |       | | |   | |     | |                               |                     
 | | | | | |         |   | |     | +-----------|-----|-----------+ |   | +-----|-|-|-------------------------|-----------+     +-|-|-|-------------+                               |                     
 | | | | | |         |   | |     |       | |   | |   |     |   | | |   | |     | | |           | | |         |                 | | | |   | |     |                                 |                     
 | | +---------------------|-----|-------|-|---------|-----|-----------|-|-----|---|-+       +-------+       |                 +-|-|-+   | |     | +---------------------------------+                   
 | |   | | |         |   | |     |       | |   | |   |     |   | | |   | |     | | | |       | | | | |       |                   | |     | |     | |                               | |                   
 | |   +-|-|---------|---|-------|---------|---|-|---------------|-------|---------|---------|-|-|-|---------|---------------------|-------|---------+                             | |             +-+   
 | |     | |         |   | |     |       | |   | |   |     |   | | |   | |     | | | |       | | | | |       |                   | |     | |     | | |                             | |             | |   
 | |     | |         |   | |     +-------|-----|-----------|---|---|---+ |     | | | |       | +-+ +---------|---------------+   | |     | |     | | |                             | |             | |   
 | |     | |         |   | |             | |   | |   |     |   | | |     |     | | | |       |       |       |               |   | |     | |     | | |                             | |             | |   
 | | +---+ |         |   | |             | |   | |   |     |   | | |   +---------|-|-|-------|---------+     |               |   +---------|-----+ +-+                             | |             | |   
 | | |     |         |   | |             | |   | |   |     |   | | |   | |     | | | |       |       | |     |               |     |     | |                                       | |             | |   
 | | |     |         |   | |   +---------|-+   | |   |     |   | +-----+ |     +-----|-------+       +-+     +---------------+     |     | |                                       | |             | |   
 | | |     |         |   | |   |         |     | |   |     |   |   |     |       | | |                                             |     | |                                       | |             | |   
 | | |     |         |   | |   +---------|-------|---------|---|---|-----|-----------|---------------------------------------------|-------+   +-------------------------------------|---------------+   
 | | |     |         |   | |             |     | |   |     |   |   |     |       | | |                                             |     |     |                                   | |             |     
 | | |     +---------+   | +-------------|-----------|---------|---|-------------|-------------------------------------------------+     |     |                                   | |             |     
 | | |                   |               |     | |   |     |   |   |     |       | | |                                                   |     |                                   | |             |     
 | | |                   |     +---------+ +---------|---+ +---|---------+       +-+ +---------------------------------------------+     |     |                                   | |             |     
 | | |                   |     |           |   | |   |   |     |   |                                                               |     |     |                                   | |             |     
 +-+ +-------------------------|-----------+ +-+ +---|---+     |   +---------------------------------------------------------------+     +-----+                                   | +-------------+     
                         |     |             |       |         |                                                                                                                   |                     
                         +-----+             +-------+         +--------------------------------------------B----------------------------------------------------------------------+                     
                                                                                                                                                                                                                                                                                                                                                                                                                  
"""

DIRECTIONS = {'N': (-1, 0), 'E': (0, 1), 'S': (1, 0), 'W': (0, -1)}
OPPOSITE_DIRECTIONS = {'N': 'S', 'E': 'W', 'S': 'N', 'W': 'E'}


def go_in_direction(coords, direction):
    new_coord = list(coords)
    new_coord[0] += DIRECTIONS[direction][0]
    new_coord[1] += DIRECTIONS[direction][1]
    return new_coord


def plus_turn(grid, coords, direction_from):
    if grid[coords[0]][coords[1]] != '+':
        return None
    for direction in DIRECTIONS:
        if direction == direction_from or direction == OPPOSITE_DIRECTIONS[direction_from]:
            continue
        new_coord = go_in_direction(coords, direction)
        if grid[new_coord[0]][new_coord[1]] != ' ':
            return direction


def follow_line(grid, coords, direction):
    letters_seen = ""
    steps_taken = 0
    while True:
        new_coords = go_in_direction(coords, direction)
        try:
            char_at_coords = grid[new_coords[0]][new_coords[1]]
        except IndexError:
            print("Bad coordinates: %r" % new_coords)
            return None, None, None
        if char_at_coords == '+':
            new_direction = plus_turn(grid, new_coords, direction)
            steps_taken += 1
            return letters_seen, new_coords, new_direction, steps_taken
        elif char_at_coords in ('|', '-'):
            coords = new_coords
            steps_taken += 1
            continue
        elif char_at_coords == ' ':
            print("Bad thing happened, space at %r with no plus" % new_coords)
            return letters_seen, None, None, steps_taken
        else:
            letters_seen += char_at_coords
            coords = new_coords
            steps_taken += 1
            continue


MAZE = INPUT.split("\n")

current_coords = [0, MAZE[0].index('|')]
current_direction = 'S'
all_letters = ""
total_steps = 1

while current_coords is not None:
    letters_seen, current_coords, current_direction, steps_taken = follow_line(MAZE, current_coords, current_direction)
    if letters_seen is not None:
        all_letters += letters_seen
    total_steps += steps_taken
    #print("Followed a line, ended up at coordinates %r going %s, %d steps taken" % (current_coords, current_direction, steps_taken))
    if letters_seen != "":
        print("Saw the letters %s" % letters_seen)

print("Letters seen: %s" % all_letters)
print("Steps taken: %d" % total_steps)
